#!/bin/sh

PN=uam
PV=0.0.6
FC_API_WANT=0

conf_init() {
	fc_inherit install patch
	
	fc_export_functions \
		conf_get_targets

	# override the default prefix
	: ${PREFIX=/}
}

conf_get_targets() {
	local d s scripts

	fc_export scriptdir '$(LIBDIR)/udev/uam'
	fc_export confdir '$(SYSCONFDIR)/udev'
	fc_export hookdir '$(confdir)/uam-hooks'
	fc_export rulesdir '$(SYSCONFDIR)/udev/rules.d'

	fc_set_builddir build

	# the executables
	scripts='build/uam-mount.sh build/uam-umount.sh build/find-helper.sh'
	for s in ${scripts}; do
		fc_sed src/${s#build/} ${s} \
			's:^\(LIBDIR=\).*$$:\1$(scriptdir):'
	done
	fc_install -x '$(scriptdir)' ${scripts}

	# the utility scripts
	fc_sed src/uam-common.sh build/uam-common.sh \
		's:^\(CONFDIR=\).*$$:\1$(confdir):' \
		's:^\(SYSLIBDIR=\).*$$:\1$(LIBDIR):' \
		's:^\(HOOKDIR=\).*$$:\1$(hookdir):' \
		"s:^\(VERSION=\).*\$\$:\1${PV}:"
	fc_install '$(scriptdir)' build/uam-common.sh \
		src/array.awk src/mounts.awk

	# the udev rule file
	fc_sed 80-uam.rules build/80-uam.rules \
		's:/lib/udev/uam:$(scriptdir):'
	fc_install '$(rulesdir)' build/80-uam.rules

	# the config file (XXX: protect it)
	fc_install '$(confdir)' uam.conf

	# the hooks
	for d in pre-mount post-mount pre-umount post-umount mount-failed; do
		set -- uam-hooks/${d}/*
		if [ -f "${1}" ]; then
			fc_install '$(hookdir)'/${d} "${@}"
		else
			fc_install_dir -k '$(hookdir)'/${d}
		fi
	done
}

. fastconf.sh

echo 'This package requires fastconf in order to be built.'
echo 'Please grab it from:'
echo '	http://github.com/mgorny/fastconf/'
echo 'or your favourite package manager and install.'
echo 'Afterwards, rerun this ./configure script. Thank you.'
exit 2
